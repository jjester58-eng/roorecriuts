<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

/* ==============================
   Firebase Configuration
============================== */
const firebaseConfig = {
  apiKey: "AIzaSyB0DxK1oKMbpC38mH9_fP6XzTOmNwZh-Go",
  authDomain: "roosports-117c3.firebaseapp.com",
  projectId: "roosports-117c3",
  storageBucket: "roosports-117c3.firebasestorage.app",
  messagingSenderId: "894863108698",
  appId: "1:894863108698:web:2e3229b93bca82accc4663",
  measurementId: "G-HH4CJNWWH0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app, "roorecruits2");

/* ==============================
   Populate Grad Years
============================== */
async function loadGradYears() {
  const select = document.getElementById("gradSelect");
  select.innerHTML = "";
  const snap = await getDocs(collection(db, "athletes"));
  const years = new Set();

  snap.forEach(doc => {
    if (doc.data().gradYear) years.add(String(doc.data().gradYear));
  });

  [...years].sort().forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = `Class of ${y}`;
    select.appendChild(opt);
  });
}

/* ==============================
   Populate Sports Dropdown Dynamically
============================== */
async function loadSports() {
  const sportSelect = document.getElementById("sportSelect");
  sportSelect.innerHTML = `<option value="all">All Sports</option>`;

  const snap = await getDocs(collection(db, "athleteSports"));
  const sports = new Set();
  snap.forEach(doc => {
    if (doc.data().sport) sports.add(doc.data().sport.toLowerCase());
  });

  [...sports].sort().forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s.charAt(0).toUpperCase() + s.slice(1);
    sportSelect.appendChild(opt);
  });
}

/* ==============================
   Load Head Coach Info
============================== */
async function loadCoach(sport) {
  if (sport === "all") return null;

  const coachSnap = await getDocs(
    query(collection(db, "coaches"), where("sport", "==", sport))
  );

  let coach = null;
  coachSnap.forEach(doc => {
    coach = doc.data(); // only take the first one
  });

  const coachContainerId = "coachContainer";
  let container = document.getElementById(coachContainerId);
  if (!container) {
    container = document.createElement("div");
    container.id = coachContainerId;
    container.className = "head-coach";
    document.body.insertBefore(container, document.getElementById("athleteContainer"));
  }

  if (coach) {
    container.innerHTML = `<h3>Head Coach: ${coach.name}</h3>
                           <p>Email: <a href="mailto:${coach.email}">${coach.email}</a></p>`;
  } else {
    container.innerHTML = "";
  }
}

/* ==============================
   Load Athletes
============================== */
window.loadBoard = async function () {
  const gradYear = document.getElementById("gradSelect").value;
  const sport = document.getElementById("sportSelect").value;
  const container = document.getElementById("athleteContainer");

  container.innerHTML = `<div class="loading">Loading athletes...</div>`;
  await loadCoach(sport);

  const athletesSnap = await getDocs(
    query(collection(db, "athletes"), where("gradYear", "==", gradYear))
  );

  const athletes = {};
  athletesSnap.forEach(d => athletes[d.id] = d.data());

  const sportSnap = sport === "all"
    ? await getDocs(collection(db, "athleteSports"))
    : await getDocs(query(collection(db, "athleteSports"), where("sport", "==", sport)));

  const players = [];
  sportSnap.forEach(doc => {
    const s = doc.data();
    const a = athletes[s.athleteId];
    if (a) players.push({ ...a, ...s });
  });

  container.innerHTML = "";
  if (players.length === 0) {
    container.innerHTML = `<div class="error">No athletes found for this selection.</div>`;
    return;
  }

  players.forEach(p => {
    const card = document.createElement("div");
    card.className = "player-card";
    card.innerHTML = `
      <img class="player-photo" src="${p.photoUrl || 'https://via.placeholder.com/300x250'}">
      <h3>${p.name || "Unknown"} <span class="jersey">#${p.jersey || "—"}</span></h3>
      <p class="meta">
        <strong>${p.sport}</strong> • ${p.position}<br>
        ${p.height || "-"} • ${p.weight || "-"} lbs • GPA ${p.gpa || "-"}
      </p>`;
    container.appendChild(card);
  });
};

/* ==============================
   Initial Boot
============================== */
await loadGradYears();
await loadSports();
loadBoard();
</script>
