<script type="module">
const PROJECT_ID = "roo-recruits";
const DATABASE = "(default)"; // For REST API, this is usually "(default)"
const COLLECTION_ATHLETES = "athletes";
const COLLECTION_SPORTS = "athleteSports";
const COLLECTION_COACHES = "coaches";

// Firestore REST base URL
const FIRESTORE_BASE = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/roorecruits2/documents`;

/* ==============================
   Helper to fetch documents from Firestore
============================== */
async function fetchCollection(collectionName, filters = []) {
  let url = `${FIRESTORE_BASE}/${collectionName}`;
  const response = await fetch(url);
  const data = await response.json();
  if (!data.documents) return [];
  
  return data.documents.map(doc => {
    const fields = doc.fields || {};
    const formatted = {};
    for (let key in fields) {
      const valObj = fields[key];
      formatted[key] = valObj.stringValue || "";
    }
    formatted.id = doc.name.split("/").pop();
    return formatted;
  }).filter(doc => {
    return filters.every(f => doc[f.field] === f.value);
  });
}

/* ==============================
   Populate Grad Years
============================== */
async function loadGradYears() {
  const select = document.getElementById("gradSelect");
  select.innerHTML = "";
  const athletes = await fetchCollection(COLLECTION_ATHLETES);
  const years = new Set(athletes.map(a => a.gradYear).filter(Boolean));
  [...years].sort().forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = `Class of ${y}`;
    select.appendChild(opt);
  });
}

/* ==============================
   Populate Sports
============================== */
async function loadSports() {
  const select = document.getElementById("sportSelect");
  select.innerHTML = `<option value="all">All Sports</option>`;
  const sportsDocs = await fetchCollection(COLLECTION_SPORTS);
  const sports = new Set(sportsDocs.map(s => s.sport).filter(Boolean));
  [...sports].sort().forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s.charAt(0).toUpperCase() + s.slice(1);
    select.appendChild(opt);
  });
}

/* ==============================
   Load Head Coach
============================== */
async function loadCoach(sport) {
  const container = document.getElementById("coachInfo");
  if (sport === "all") {
    container.style.display = "none";
    container.innerHTML = "";
    return;
  }
  const coaches = await fetchCollection(COLLECTION_COACHES, [{ field: "sport", value: sport }]);
  if (coaches.length === 0) {
    container.style.display = "none";
    container.innerHTML = "";
    return;
  }
  const coach = coaches[0];
  container.innerHTML = `
    <h3>Head Coach: ${coach.name}</h3>
    <p>Email: <a href="mailto:${coach.email}">${coach.email}</a></p>
  `;
  container.style.display = "block";
}

/* ==============================
   Load Athletes
============================== */
async function loadBoard() {
  const gradYear = document.getElementById("gradSelect").value;
  const sport = document.getElementById("sportSelect").value;
  const container = document.getElementById("athleteContainer");
  container.innerHTML = `<div class="loading">Loading athletes...</div>`;

  await loadCoach(sport);

  // 1️⃣ Fetch athletes for the grad year
  const athletes = await fetchCollection(COLLECTION_ATHLETES, [{ field: "gradYear", value: gradYear }]);
  const athleteMap = {};
  athletes.forEach(a => athleteMap[a.id] = a);

  // 2️⃣ Fetch athleteSports
  const sportDocs = sport === "all"
    ? await fetchCollection(COLLECTION_SPORTS)
    : await fetchCollection(COLLECTION_SPORTS, [{ field: "sport", value: sport }]);

  const players = [];
  sportDocs.forEach(s => {
    const a = athleteMap[s.athleteId];
    if (a) players.push({ ...a, ...s });
  });

  // 3️⃣ Render
  container.innerHTML = "";
  if (players.length === 0) {
    container.innerHTML = `<div class="error">No athletes found for this selection.</div>`;
    return;
  }

  players.forEach(p => {
    const card = document.createElement("div");
    card.className = "player-card";
    card.innerHTML = `
      <img class="player-photo" src="${p.photoUrl || 'https://via.placeholder.com/300x250'}">
      <h3>${p.name || "Unknown"} <span class="jersey">#${p.jersey || "—"}</span></h3>
      <p class="meta">
        <strong>${p.sport || "-"}</strong> • ${p.position || "-"}<br>
        ${p.height || "-"} • ${p.weight || "-"} lbs • GPA ${p.gpa || "-"}
      </p>
    `;
    container.appendChild(card);
  });
}

/* ==============================
   Init
============================== */
await loadGradYears();
await loadSports();

document.getElementById("gradSelect").addEventListener("change", loadBoard);
document.getElementById("sportSelect").addEventListener("change", loadBoard);

loadBoard();
</script>
